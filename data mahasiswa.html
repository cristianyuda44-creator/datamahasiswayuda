<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <title>
      Aplikasi Manajemen Data Mahasiswa - Final (Sorting & Dashboard Fix)
    </title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --blue: #0066ff;
        --danger: #e11d48;
        --muted: #6b7280;
        --card: #ffffff;
        --bg: #f5f7fb;
        --sidebar: #ffffff;
        --text: #111827;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Inter, Arial, sans-serif;
        margin: 0;
        padding: 18px;
        background: var(--bg);
        color: var(--text);
      }
      header {
        background: var(--blue);
        color: #fff;
        padding: 12px 18px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
      }
      .layout {
        display: flex;
        gap: 20px;
        margin-top: 16px;
        align-items: flex-start;
      }
      /* sidebar */
      .sidebar {
        width: 220px;
        background: var(--sidebar);
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        position: sticky;
        top: 18px;
        height: calc(100vh - 60px);
        overflow: auto;
      }
      .profile {
        text-align: center;
        padding-bottom: 12px;
        border-bottom: 1px solid #f0f0f0;
      }
      .avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 20px;
      }
      .name {
        font-weight: 700;
        margin: 0;
      }
      .nim {
        color: var(--muted);
        font-size: 12px;
        margin-top: 6px;
      }
      .menu {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .menu button {
        text-align: left;
        padding: 10px 12px;
        border-radius: 8px;
        border: none;
        background: #f3f6fb;
        color: #111;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .menu button.active {
        background: #e6f0ff;
        color: var(--blue);
        font-weight: 600;
      }
      .file-actions {
        margin-top: 14px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .file-actions button {
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: #06b6d4;
        color: #fff;
        cursor: pointer;
      }

      /* main */
      .main {
        flex: 1;
      }
      .card {
        background: var(--card);
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.04);
        margin-bottom: 16px;
      }
      .inline {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      input,
      select {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e6edf6;
      }
      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        background: var(--blue);
        color: #fff;
        cursor: pointer;
      }
      .btn.red {
        background: var(--danger);
      }
      .table-wrap {
        overflow: auto;
        max-height: 420px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }
      th,
      td {
        padding: 12px 10px;
        text-align: left;
        border-bottom: 1px solid #f0f3f7;
        font-size: 14px;
      }
      th {
        background: #fbfcfe;
        position: sticky;
        top: 0;
        z-index: 1;
      }
      .actions button {
        margin-right: 6px;
      }

      /* search/sort area */
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
      .controls .grow {
        flex: 1;
      }
      .controls select,
      .controls input {
        min-width: 160px;
      }

      /* dashboard area */
      .dashboard-grid {
        display: flex;
        gap: 18px;
        align-items: flex-start;
      }
      .chart-box {
        flex: 1;
        min-width: 360px;
      }
      .ranking-box {
        width: 300px;
      }

      /* login modal */
      #loginBox {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #1d4ed8, #2563eb);
        z-index: 9999;
      }
      #loginBox .panel {
        background: #fff;
        padding: 26px;
        border-radius: 12px;
        width: 420px;
        box-shadow: 0 20px 60px rgba(2, 6, 23, 0.3);
        text-align: center;
        transform: translateY(0);
        animation: pop 0.35s ease;
      }
      @keyframes pop {
        from {
          opacity: 0;
          transform: translateY(20px) scale(0.98);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      #loginBox input {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #eee;
      }
      #notifSukses,
      #notifError {
        position: fixed;
        top: 18px;
        right: 18px;
        padding: 10px 12px;
        background: #111;
        color: #fff;
        border-radius: 8px;
        display: none;
        z-index: 99999;
      }
      #notifError {
        right: auto;
        left: 18px;
        background: #dc2626;
      }

      /* dark mode */
      body.dark {
        background: #0f1724;
        color: #e6eef8;
      }
      body.dark header {
        background: #0b5bd1;
      }
      body.dark .card {
        background: #0b1220;
        box-shadow: none;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      body.dark th,
      body.dark td {
        border-color: rgba(255, 255, 255, 0.03);
      }
      body.dark input,
      body.dark select {
        background: #071022;
        color: #e6eef8;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      /* responsive */
      @media (max-width: 900px) {
        .layout {
          flex-direction: column;
        }
        .sidebar {
          position: relative;
          width: 100%;
          height: auto;
        }
        .ranking-box {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- LOGIN (initial) -->
    <div id="loginBox">
      <div class="panel">
        <h2 style="margin: 0 0 8px">LOGIN</h2>
        <input id="adminUser" placeholder="Username" />
        <input id="adminPass" type="password" placeholder="Password" />
        <div
          style="
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
          "
        >
          <button class="btn" onclick="loginAdmin()">Login</button>
          <button
            style="background: #6b7280"
            class="btn"
            onclick="fillSample()"
          >
            Isi contoh
          </button>
        </div>
        <p style="margin-top: 10px; color: #666">
          Username: <b>Cristian Yuda</b> | Password: <b>YUDA22</b>
        </p>
        <p id="loginError" style="color: red"></p>
      </div>
    </div>

    <div id="notifSukses">‚úÖ Sukses</div>
    <div id="notifError">‚ùå Error</div>

    <!-- top header -->
    <header>
      <h1>üìò Aplikasi Manajemen Data Mahasiswa</h1>
      <div
        style="margin-left: auto; display: flex; gap: 8px; align-items: center"
      >
        <button id="toggleDark" class="btn" onclick="toggleDarkMode()">
          üåô Dark Mode
        </button>
        <button class="btn red" onclick="logout()">üö™ Logout</button>
      </div>
    </header>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="profile">
          <div id="avatar" class="avatar" style="background: #06b6d4">CY</div>
          <p class="name">CRISTIAN YUDA</p>
          <p class="nim">241011402026</p>
        </div>

        <div class="menu">
          <button id="btnAdd" class="active" onclick="showSection('add')">
            ‚ûï Input Mahasiswa
          </button>
          <button id="btnData" onclick="showSection('data')">
            üìã Data Mahasiswa
          </button>
          <button id="btnDash" onclick="gotoDashboard()">
            üìä Dashboard & IPK
          </button>
        </div>

        <div class="file-actions">
          <button onclick="exportJSON()">üìÅ Export JSON</button>
          <button onclick="exportCSV()">üìÑ Export CSV</button>
          <label
            style="
              display: block;
              cursor: pointer;
              background: #06b6d4;
              color: #fff;
              padding: 10px;
              border-radius: 8px;
              text-align: center;
            "
          >
            üìÇ Import JSON
            <input
              id="importFile"
              type="file"
              accept="application/json"
              onchange="importJSON(event)"
              style="display: none"
            />
          </label>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <!-- ADD SECTION -->
        <div id="section-add" class="card">
          <h2>Tambah Mahasiswa</h2>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
              gap: 10px;
            "
          >
            <input id="nama" placeholder="Nama" />
            <input id="nim" placeholder="NIM (12 digit)" />
            <input id="prodi" placeholder="Program Studi (opsional)" />
            <input id="kelas" placeholder="Kelas (opsional)" />
            <input id="foto" placeholder="URL Foto (opsional)" />
            <input id="ipk" placeholder="IPK (0.00 - 4.00)" />
          </div>
          <div style="margin-top: 10px">
            <button class="btn" onclick="tambahMahasiswa()">Simpan</button>
            <button
              style="background: #6b7280"
              class="btn"
              onclick="resetForm()"
            >
              Reset
            </button>
          </div>
        </div>

        <!-- DATA SECTION -->
        <div id="section-data" class="card" style="display: none">
          <h2>Data Mahasiswa</h2>

          <div class="controls">
            <input
              id="searchKey"
              class="grow"
              placeholder="Cari nama / NIM / prodi"
              onkeydown="if(event.key==='Enter') cariMahasiswa()"
            />
            <select id="searchMethod">
              <option value="linear">Linear Search (O(n))</option>
              <option value="binary">Binary Search (O(log n)) - by NIM</option>
              <option value="sequential">Sequential Search (O(n))</option>
            </select>
            <button class="btn" onclick="cariMahasiswa()">Cari</button>

            <select id="sortColumn">
              <option value="nim">NIM</option>
              <option value="nama">Nama</option>
              <option value="ipk">IPK</option>
              <option value="prodi">Prodi</option>
            </select>

            <select id="sortType">
              <option value="bubble">Bubble Sort</option>
              <option value="insertion">Insertion Sort</option>
              <option value="selection">Selection Sort</option>
              <option value="merge">Merge Sort</option>
              <option value="shell">Shell Sort</option>
            </select>

            <select id="sortOrder">
              <option value="asc">Ascending</option>
              <option value="desc">Descending</option>
            </select>

            <button class="btn" onclick="urutMahasiswa()">Urutkan</button>
            <button
              style="background: #6b7280"
              class="btn"
              onclick="resetOrder()"
            >
              Reset Urutan
            </button>
          </div>

          <div
            id="hasilCari"
            style="color: var(--muted); margin-top: 6px"
          ></div>

          <div class="table-wrap card" style="padding: 0; margin-top: 12px">
            <table id="tableMhs">
              <thead>
                <tr>
                  <th style="width: 48px">No</th>
                  <th>Nama</th>
                  <th>NIM</th>
                  <th>Prodi</th>
                  <th>Kelas</th>
                  <th style="width: 90px">IPK</th>
                  <th style="width: 180px">Aksi</th>
                </tr>
              </thead>
              <tbody id="tabelMahasiswa"></tbody>
            </table>
          </div>
        </div>

        <!-- DASHBOARD -->
        <div id="section-dash" class="card" style="display: none">
          <h2>Dashboard & Statistik</h2>
          <div class="dashboard-grid" style="align-items: flex-start">
            <div class="chart-box card" style="padding: 12px">
              <p>
                Total Mahasiswa: <b id="totalMhs">0</b> &nbsp; Rata-rata IPK:
                <b id="rataIpk">0.00</b>
              </p>
              <canvas id="chartIpk" height="220"></canvas>
            </div>

            <div class="ranking-box card">
              <h3>Ranking IPK</h3>
              <table style="width: 100%">
                <thead>
                  <tr>
                    <th style="width: 48px">Rank</th>
                    <th>Nama</th>
                    <th style="width: 70px">IPK</th>
                  </tr>
                </thead>
                <tbody id="rankingIpk"></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      /*
  Final single-file app.
  - Sorting improvements: sorts by chosen column, toggles asc/desc, reset to original order.
  - Binary search works without page refresh (search on a sorted copy).
  - "Dashboard & IPK" button scrolls to dashboard section smoothly.
  - Dark mode changes text color so menu labels remain visible.
  - Login credentials: Cristian Yuda / YUDA22
*/

      /* -----------------------
   OOP: Mahasiswa classes
   ----------------------- */
      class Mahasiswa {
        constructor(
          nama,
          nim,
          jurusan = "Teknik Informatika",
          foto = "",
          prodi = "",
          kelas = "",
          ipk = 0.0,
          status = "Aktif"
        ) {
          this.nama = nama;
          this.nim = nim;
          this.jurusan = jurusan;
          this.foto = foto;
          this.prodi = prodi || jurusan;
          this.kelas = kelas;
          this.ipk = parseFloat(ipk) || 0;
          this.status = status;
        }
        display() {
          return `${this.nama} | ${this.nim} | ${this.prodi} | IPK:${this.ipk}`;
        }
      }
      class MahasiswaAktif extends Mahasiswa {
        constructor(...args) {
          super(...args);
        }
      }

      /* -----------------------
   Persistence (localStorage)
   ----------------------- */
      const STORAGE_KEY = "dbMhs_final_v2";
      let database = []; // current visible order
      let originalDB = []; // preserved original load order (for reset)
      let editIndex = -1;

      /* -----------------------
   Seed / Load
   ----------------------- */
      function seedInitialData() {
        // Full list derived from user's provided class list (sample). Add all real names you need.
        // I included 32 entries from user-provided PDF/images. Adjust as needed.
        const arr = [
          ["ADLINA NAILYANTI", "241011402755"],
          ["ADRIAN MULYA AKBAR", "241011400228"],
          ["AFDAL LAIA", "241011402051"],
          ["AFFAN DHIYA DIL AWAR", "241011400266"],
          ["ALFRENDO SURANTA", "241011401526"],
          ["BAYU ABIAKSO", "241011400277"],
          ["CRISTIAN YUDA", "241011402026"],
          ["DIMAS AKBAR FATUROHMAN", "241011400248"],
          ["ELISABETH TES LAE", "241011402113"],
          ["FADLY HIMAWAN SAPUTRA", "241011401528"],
          ["FARIZ ADITYA ARDHANA", "241011400268"],
          ["FAYA NUR RIDHO", "241011403270"],
          ["FIRMAN GANI", "241011400233"],
          ["GILANG NOVRIZAL", "241011400269"],
          ["HAFIDZ FADILLAH", "221011401394"],
          ["M. FAKHRURROZI", "241011400231"],
          ["M. RAKA NURIDWAN", "241011400256"],
          ["MECHAIL ADE VAHROZI", "241011400276"],
          ["MEDINA FIKANTI", "241011401536"],
          ["MUHAMAD FAZRI", "241011402315"],
          ["MUHAMAD RIPQI ALAMSYAH", "221011401247"],
          ["MUHAMAD YUNUS SAPUTRA", "221011402528"],
          ["MUHAMMAD ARFAN ALBAAR", "211011450013"],
          ["MUHAMMAD ICHSAN FACHRULROZI", "241011400235"],
          ["MUHAMMAD JIWA ISLAMUTIDAR", "241011401525"],
          ["MUHAMMAD SULTAN", "191011402813"],
          ["MUHAMMAD ZIDAN", "241011401533"],
          ["MUZAYIN ARIFIN", "241011400261"],
          ["RIDO MAULIDAN", "241011400232"],
          ["STEVANIA NAILA SADING", "241011400254"],
          ["SULTHAN ARYA SATWIKA", "241011401769"],
          ["SYAHRUL KHAIRUL AQBAR", "241011400253"],
          ["TIMOTHY TARUMASELLEY", "241011401936"],
          ["ULYA KHODILAH", "241011401655"],
          ["YEHEZKIEL PASKAH", "241011402104"],
        ];
        // Convert to MahasiswaAktif with default ipk 0
        return arr.map(
          (a) =>
            new MahasiswaAktif(
              a[0],
              a[1],
              "Teknik Informatika",
              "",
              "Teknik Informatika",
              "03TPLP006",
              0.0
            )
        );
      }

      function loadDatabase() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const arr = JSON.parse(raw);
            database = arr.map(
              (o) =>
                new MahasiswaAktif(
                  o.nama,
                  o.nim,
                  o.jurusan,
                  o.foto || "",
                  o.prodi || o.jurusan,
                  o.kelas || "",
                  o.ipk || 0,
                  o.status || "Aktif"
                )
            );
          } else {
            database = seedInitialData();
            saveDatabase();
          }
          // keep a copy of original order (deep copy)
          originalDB = database.map((m) => Object.assign({}, m));
        } catch (e) {
          showError("Gagal load DB: " + e);
          database = seedInitialData();
          originalDB = database.map((m) => Object.assign({}, m));
          saveDatabase();
        }
      }

      function saveDatabase() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(database));
        } catch (e) {
          showError("Gagal simpan: " + e);
        }
      }

      /* -----------------------
   Notif
   ----------------------- */
      function showSuccess(msg) {
        const n = document.getElementById("notifSukses");
        n.innerText = "‚úÖ " + msg;
        n.style.display = "block";
        setTimeout(() => (n.style.display = "none"), 2500);
      }
      function showError(msg) {
        const n = document.getElementById("notifError");
        n.innerText = "‚ùå " + msg;
        n.style.display = "block";
        setTimeout(() => (n.style.display = "none"), 3500);
      }

      /* -----------------------
   Validation (regex)
   ----------------------- */
      const namaRegex = /^[a-zA-Z\s\.\-']+$/;
      const nimRegex = /^[0-9]{10,12}$/; // allow 10-12 tolerant
      const ipkRegex = /^(?:[0-3](?:\.\d{1,2})?|4(?:\.00?)?)$/;

      /* -----------------------
   CRUD
   ----------------------- */
      function tambahMahasiswa() {
        try {
          const nama = document.getElementById("nama").value.trim();
          const nim = document.getElementById("nim").value.trim();
          const prodi =
            document.getElementById("prodi").value.trim() ||
            "Teknik Informatika";
          const kelas =
            document.getElementById("kelas").value.trim() || "03TPLP006";
          const foto = document.getElementById("foto").value.trim();
          const ipkRaw = document.getElementById("ipk").value.trim();

          if (!namaRegex.test(nama)) {
            showError("Nama tidak valid. Hanya huruf/spasi/punkt.");
            return;
          }
          if (!nimRegex.test(nim)) {
            showError("NIM harus 10-12 digit.");
            return;
          }
          if (ipkRaw && !ipkRegex.test(ipkRaw)) {
            showError("IPK harus 0.00 - 4.00");
            return;
          }
          const ipk = ipkRaw ? parseFloat(parseFloat(ipkRaw).toFixed(2)) : 0.0;

          database.push(
            new MahasiswaAktif(
              nama,
              nim,
              "Teknik Informatika",
              foto,
              prodi,
              kelas,
              ipk
            )
          );
          saveDatabase();
          tampilkan();
          showSuccess("Data disimpan");
          resetForm();
        } catch (e) {
          showError("Gagal tambah: " + e);
        }
      }

      function bukaModal(i) {
        editIndex = i;
        const m = database[i];
        // reuse add fields for simplicity (or implement a modal)
        document.getElementById("nama").value = m.nama;
        document.getElementById("nim").value = m.nim;
        document.getElementById("prodi").value = m.prodi;
        document.getElementById("kelas").value = m.kelas;
        document.getElementById("foto").value = m.foto;
        document.getElementById("ipk").value = (m.ipk || 0).toFixed(2);
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function simpanEdit() {
        try {
          if (editIndex < 0) {
            showError("Tidak ada data dipilih");
            return;
          }
          const newNama = document.getElementById("nama").value.trim();
          const newNim = document.getElementById("nim").value.trim();
          const newProdi = document.getElementById("prodi").value.trim();
          const newKelas = document.getElementById("kelas").value.trim();
          const newFoto = document.getElementById("foto").value.trim();
          const newIpkRaw = document.getElementById("ipk").value.trim();

          if (!namaRegex.test(newNama)) {
            showError("Nama tidak valid");
            return;
          }
          if (!nimRegex.test(newNim)) {
            showError("NIM tidak valid");
            return;
          }
          if (newIpkRaw && !ipkRegex.test(newIpkRaw)) {
            showError("IPK tidak valid");
            return;
          }
          const newIpk = newIpkRaw
            ? parseFloat(parseFloat(newIpkRaw).toFixed(2))
            : 0.0;

          const m = database[editIndex];
          m.nama = newNama;
          m.nim = newNim;
          m.prodi = newProdi;
          m.kelas = newKelas;
          m.foto = newFoto;
          m.ipk = newIpk;
          saveDatabase();
          tampilkan();
          showSuccess("Perubahan disimpan");
          editIndex = -1;
          resetForm();
        } catch (e) {
          showError("Gagal simpan edit: " + e);
        }
      }

      function hapusMahasiswa(i) {
        if (!confirm("Yakin hapus?")) return;
        database.splice(i, 1);
        saveDatabase();
        tampilkan();
        showSuccess("Data dihapus");
      }

      function resetForm() {
        document.getElementById("nama").value = "";
        document.getElementById("nim").value = "";
        document.getElementById("prodi").value = "";
        document.getElementById("kelas").value = "";
        document.getElementById("foto").value = "";
        document.getElementById("ipk").value = "";
      }

      /* -----------------------
   Display / Pagination (simple)
   ----------------------- */
      let page = 1,
        perPage = 1000; // show all by default
      function tampilkan() {
        try {
          const tbody = document.getElementById("tabelMahasiswa");
          tbody.innerHTML = "";
          for (let i = 0; i < database.length; i++) {
            const m = database[i];
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${escapeHtml(m.nama)}</td>
        <td>${m.nim}</td>
        <td>${escapeHtml(m.prodi || m.jurusan)}</td>
        <td>${m.kelas || "-"}</td>
        <td>${(m.ipk || 0).toFixed(2)}</td>
        <td class="actions">
          <button class="btn" onclick="bukaModal(${i})">Edit</button>
          <button class="btn red" onclick="hapusMahasiswa(${i})">Hapus</button>
          <button style="background:#6b7280" class="btn" onclick="lihatDetail(${i})">Detail</button>
        </td>
      `;
            tbody.appendChild(tr);
          }
          document.getElementById("totalMhs").innerText = database.length;
          hitungStatistik();
          updateGrafikIpk();
          tampilkanRankingIpk();
        } catch (e) {
          showError("Gagal tampil: " + e);
        }
      }

      /* -----------------------
   Detail
   ----------------------- */
      function lihatDetail(i) {
        const m = database[i];
        alert(
          `${m.nama}\nNIM: ${m.nim}\nProdi: ${m.prodi}\nKelas: ${
            m.kelas
          }\nIPK: ${(m.ipk || 0).toFixed(2)}`
        );
      }

      /* -----------------------
   Search (linear, sequential (same), binary)
   - Binary search will sort a temporary copy by NIM and then search
   - No page refresh required
   ----------------------- */
      function linearSearchKey(key) {
        const res = [];
        for (let i = 0; i < database.length; i++) {
          const m = database[i];
          if (
            m.nama.toLowerCase().includes(key) ||
            m.nim.includes(key) ||
            (m.prodi || "").toLowerCase().includes(key)
          )
            res.push({ index: i, item: m });
        }
        return res;
      }
      function sequentialSearchKey(key) {
        return linearSearchKey(key);
      }
      function binarySearchByNim(key) {
        // sort a copy by nim ascending
        const copy = database
          .slice()
          .sort((a, b) => a.nim.localeCompare(b.nim));
        let left = 0,
          right = copy.length - 1,
          res = [];
        while (left <= right) {
          const mid = Math.floor((left + right) / 2);
          const midVal = copy[mid].nim;
          if (midVal === key) {
            // collect neighbors equal
            let l = mid,
              r = mid;
            while (l - 1 >= 0 && copy[l - 1].nim === key) l--;
            while (r + 1 < copy.length && copy[r + 1].nim === key) r++;
            for (let k = l; k <= r; k++)
              res.push({ index: database.indexOf(copy[k]), item: copy[k] });
            break;
          } else if (midVal < key) left = mid + 1;
          else right = mid - 1;
        }
        return res;
      }

      function cariMahasiswa() {
        const raw = document.getElementById("searchKey").value.trim();
        const method = document.getElementById("searchMethod").value;
        if (!raw) {
          document.getElementById("hasilCari").innerText =
            "Masukkan kata kunci.";
          tampilkan();
          return;
        }
        let hasil = [];
        if (method === "linear") hasil = linearSearchKey(raw.toLowerCase());
        else if (method === "sequential")
          hasil = sequentialSearchKey(raw.toLowerCase());
        else if (method === "binary") hasil = binarySearchByNim(raw); // binary by exact nim
        if (hasil.length === 0) {
          document.getElementById("hasilCari").innerText = "Tidak ditemukan";
          // optionally clear table or show none; we keep table as-is
        } else {
          // render found as temporary list
          document.getElementById(
            "hasilCari"
          ).innerHTML = `Ditemukan: ${hasil.length} hasil. (Menampilkan hasil saja)`;
          const tbody = document.getElementById("tabelMahasiswa");
          tbody.innerHTML = "";
          hasil.forEach((h, idx) => {
            const m = h.item;
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(m.nama)}</td>
        <td>${m.nim}</td>
        <td>${escapeHtml(m.prodi || m.jurusan)}</td>
        <td>${m.kelas || "-"}</td>
        <td>${(m.ipk || 0).toFixed(2)}</td>
        <td class="actions">
          <button class="btn" onclick="bukaModal(${h.index})">Edit</button>
          <button class="btn red" onclick="hapusMahasiswa(${
            h.index
          })">Hapus</button>
          <button style="background:#6b7280" class="btn" onclick="lihatDetail(${
            h.index
          })">Detail</button>
        </td>
      `;
            tbody.appendChild(tr);
          });
        }
      }

      /* -----------------------
   Sorting implementations
   - Each sorts by chosen column key
   - Ascending/descending support
   - After sort, database replaced and UI refreshed
   - Reset function restores original order (originalDB)
   ----------------------- */
      function getKeyValue(item, key) {
        if (key === "nama") return (item.nama || "").toLowerCase();
        if (key === "nim") return item.nim || "";
        if (key === "ipk") return parseFloat(item.ipk) || 0;
        if (key === "prodi") return (item.prodi || "").toLowerCase();
        return "";
      }

      /* Sorting algorithms (operate on array of objects) */
      function bubbleSortArr(arr, key) {
        const a = arr.slice();
        for (let i = 0; i < a.length - 1; i++) {
          for (let j = 0; j < a.length - i - 1; j++) {
            if (getKeyValue(a[j], key) > getKeyValue(a[j + 1], key)) {
              [a[j], a[j + 1]] = [a[j + 1], a[j]];
            }
          }
        }
        return a;
      }
      function insertionSortArr(arr, key) {
        const a = arr.slice();
        for (let i = 1; i < a.length; i++) {
          const temp = a[i];
          let j = i - 1;
          while (j >= 0 && getKeyValue(a[j], key) > getKeyValue(temp, key)) {
            a[j + 1] = a[j];
            j--;
          }
          a[j + 1] = temp;
        }
        return a;
      }
      function selectionSortArr(arr, key) {
        const a = arr.slice();
        for (let i = 0; i < a.length - 1; i++) {
          let min = i;
          for (let j = i + 1; j < a.length; j++) {
            if (getKeyValue(a[j], key) < getKeyValue(a[min], key)) min = j;
          }
          [a[i], a[min]] = [a[min], a[i]];
        }
        return a;
      }
      function mergeSortArr(arr, key) {
        if (arr.length <= 1) return arr.slice();
        const mid = Math.floor(arr.length / 2);
        const left = mergeSortArr(arr.slice(0, mid), key);
        const right = mergeSortArr(arr.slice(mid), key);
        return merge(left, right, key);
      }
      function merge(left, right, key) {
        const res = [];
        let i = 0,
          j = 0;
        while (i < left.length && j < right.length) {
          if (getKeyValue(left[i], key) <= getKeyValue(right[j], key)) {
            res.push(left[i++]);
          } else {
            res.push(right[j++]);
          }
        }
        return res.concat(left.slice(i)).concat(right.slice(j));
      }
      function shellSortArr(arr, key) {
        const a = arr.slice();
        let n = a.length;
        let gap = Math.floor(n / 2);
        while (gap > 0) {
          for (let i = gap; i < n; i++) {
            const temp = a[i];
            let j = i;
            while (
              j >= gap &&
              getKeyValue(a[j - gap], key) > getKeyValue(temp, key)
            ) {
              a[j] = a[j - gap];
              j -= gap;
            }
            a[j] = temp;
          }
          gap = Math.floor(gap / 2);
        }
        return a;
      }

      function urutMahasiswa() {
        try {
          const col = document.getElementById("sortColumn").value;
          const type = document.getElementById("sortType").value;
          const order = document.getElementById("sortOrder").value;

          // reset table first (clear render)
          document.getElementById("tabelMahasiswa").innerHTML = "";

          let arr = database.slice();
          if (type === "bubble") arr = bubbleSortArr(arr, col);
          else if (type === "insertion") arr = insertionSortArr(arr, col);
          else if (type === "selection") arr = selectionSortArr(arr, col);
          else if (type === "merge") arr = mergeSortArr(arr, col);
          else if (type === "shell") arr = shellSortArr(arr, col);

          if (order === "desc") arr.reverse();

          // assign and save
          database = arr;
          saveDatabase();
          tampilkan();
          showSuccess(
            "Data diurutkan (" + type + ", " + col + ", " + order + ")"
          );
        } catch (e) {
          showError("Gagal urut: " + e);
        }
      }

      /* Reset order to original loaded order */
      function resetOrder() {
        // originalDB is raw object copies; convert back to MahasiswaAktif instances
        database = originalDB.map(
          (o) =>
            new MahasiswaAktif(
              o.nama,
              o.nim,
              o.jurusan,
              o.foto,
              o.prodi,
              o.kelas,
              o.ipk,
              o.status
            )
        );
        saveDatabase();
        tampilkan();
        showSuccess("Urutan dikembalikan ke default");
      }

      /* -----------------------
   Dashboard & IPK
   ----------------------- */
      let ipkChartInstance = null;
      function hitungStatistik() {
        try {
          const total = database.length;
          let sum = 0;
          let max = 0;
          database.forEach((m) => {
            sum += parseFloat(m.ipk) || 0;
            if ((parseFloat(m.ipk) || 0) > max) max = parseFloat(m.ipk) || 0;
          });
          const avg = total ? (sum / total).toFixed(2) : "0.00";
          document.getElementById("rataIpk").innerText = avg;
          document.getElementById("totalMhs").innerText = total;
        } catch (e) {
          console.warn(e);
        }
      }

      function updateGrafikIpk() {
        try {
          const ctx = document.getElementById("chartIpk").getContext("2d");
          if (ipkChartInstance) ipkChartInstance.destroy();
          const labels = database.map((m) => m.nama);
          const dataIpk = database.map((m) => parseFloat(m.ipk) || 0);
          ipkChartInstance = new Chart(ctx, {
            type: "bar",
            data: { labels, datasets: [{ label: "IPK", data: dataIpk }] },
            options: { scales: { y: { beginAtZero: true, max: 4 } } },
          });
        } catch (e) {
          console.warn("Chart error", e);
        }
      }

      function tampilkanRankingIpk() {
        const tbody = document.getElementById("rankingIpk");
        const copy = [...database].sort(
          (a, b) => (parseFloat(b.ipk) || 0) - (parseFloat(a.ipk) || 0)
        );
        tbody.innerHTML = "";
        copy.forEach(
          (m, i) =>
            (tbody.innerHTML += `<tr><td>${
              i + 1
            }</td><td style="padding-left:8px">${escapeHtml(
              m.nama
            )}</td><td style="text-align:right">${(m.ipk || 0).toFixed(
              2
            )}</td></tr>`)
        );
      }

      /* -----------------------
   Export / Import
   ----------------------- */
      function exportJSON() {
        const blob = new Blob([JSON.stringify(database, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data_mahasiswa.json";
        a.click();
        URL.revokeObjectURL(url);
        showSuccess("Export JSON berhasil");
      }
      function exportCSV() {
        let csv = "Nama,NIM,Prodi,Kelas,IPK,Foto,Status\n";
        database.forEach(
          (m) =>
            (csv += `"${m.nama}","${m.nim}","${m.prodi}","${m.kelas}",${(
              m.ipk || 0
            ).toFixed(2)},"${m.foto || ""}","${m.status}"\n`)
        );
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data_mahasiswa.csv";
        a.click();
        URL.revokeObjectURL(url);
        showSuccess("Export CSV berhasil");
      }
      function importJSON(evt) {
        try {
          const file = evt.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const arr = JSON.parse(e.target.result);
              if (!Array.isArray(arr)) {
                showError("Format JSON tidak sesuai");
                return;
              }
              database = arr.map(
                (o) =>
                  new MahasiswaAktif(
                    o.nama,
                    o.nim,
                    o.jurusan || "Teknik Informatika",
                    o.foto || "",
                    o.prodi || o.jurusan,
                    o.kelas || "03TPLP006",
                    o.ipk || 0,
                    o.status || "Aktif"
                  )
              );
              originalDB = database.map((o) => Object.assign({}, o));
              saveDatabase();
              tampilkan();
              showSuccess("Import JSON berhasil");
            } catch (err) {
              showError("Gagal baca file: " + err);
            }
          };
          reader.readAsText(file);
          evt.target.value = ""; // reset input
        } catch (e) {
          showError("Gagal import: " + e);
        }
      }

      /* -----------------------
   Login / Logout
   ----------------------- */
      function loginAdmin() {
        const user = document.getElementById("adminUser").value.trim();
        const pass = document.getElementById("adminPass").value.trim();
        if (user === "Cristian Yuda" && pass === "YUDA22") {
          try {
            localStorage.setItem("isLogin", "true");
            document.getElementById("loginBox").style.display = "none";
            showSuccess("Login berhasil");
            // ensure avatar initials & colors
            setAvatarInitials("CRISTIAN YUDA");
            // show default section
            showSection("add");
            tampilkan();
          } catch (e) {
            showError("Gagal proses login: " + e);
          }
        } else {
          document.getElementById("loginError").innerText =
            "Username atau password salah";
        }
      }
      function fillSample() {
        document.getElementById("adminUser").value = "Cristian Yuda";
        document.getElementById("adminPass").value = "YUDA22";
      }
      function logout() {
        localStorage.removeItem("isLogin");
        document.getElementById("loginBox").style.display = "flex";
        showSuccess("Logout berhasil");
      }

      /* -----------------------
   UI helpers
   ----------------------- */
      function showSection(sec) {
        document.getElementById("section-add").style.display =
          sec === "add" ? "block" : "none";
        document.getElementById("section-data").style.display =
          sec === "data" ? "block" : "none";
        document.getElementById("section-dash").style.display =
          sec === "dash" ? "block" : "none";
        // active menu button styling
        document
          .querySelectorAll(".menu button")
          .forEach((b) => b.classList.remove("active"));
        if (sec === "add")
          document.getElementById("btnAdd").classList.add("active");
        if (sec === "data")
          document.getElementById("btnData").classList.add("active");
        if (sec === "dash")
          document.getElementById("btnDash").classList.add("active");
      }
      function gotoDashboard() {
        showSection("dash");
        // scroll the dashboard area into view precisely
        setTimeout(() => {
          document
            .getElementById("section-dash")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }, 80);
      }

      /* dark toggle ensuring text visibility */
      function toggleDarkMode() {
        document.body.classList.toggle("dark");
        showSuccess("Toggled theme");
      }

      /* avatar initials + color set */
      const avatarColors = [
        "#06b6d4",
        "#06b6d4",
        "#10b981",
        "#ef4444",
        "#8b5cf6",
        "#f59e0b",
        "#06b6d4",
        "#3b82f6",
      ];
      function setAvatarInitials(fullname) {
        const initials =
          fullname
            .split(" ")
            .map((p) => p[0] || "")
            .slice(0, 2)
            .join("")
            .toUpperCase() || "U";
        const el = document.getElementById("avatar");
        el.textContent = initials;
        const color =
          avatarColors[Math.abs(hashCode(fullname)) % avatarColors.length];
        el.style.background = color;
      }

      /* scroll to top helper */
      function scrollToTop() {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      /* Utility */
      function escapeHtml(s) {
        if (!s) return "";
        return s
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function hashCode(s) {
        let h = 0;
        for (let i = 0; i < s.length; i++) {
          h = (h << 5) - h + s.charCodeAt(i);
          h |= 0;
        }
        return h;
      }

      /* ---------- Initialization ---------- */
      (function init() {
        loadDatabase();
        // if previously logged in -> skip login
        if (localStorage.getItem("isLogin") === "true") {
          document.getElementById("loginBox").style.display = "none";
          setAvatarInitials("CRISTIAN YUDA");
          showSection("add");
        }
        tampilkan();
        hitungStatistik();
        updateGrafikIpk();
      })();

      /* Close: clicking outside modal does nothing (must logout to return) */

      /* -----------------------
   Extra helpers for dev:
   - resetOrder to original
   - ensure binary search and sorts don't require refresh
   ----------------------- */
    </script>
  </body>
</html>
